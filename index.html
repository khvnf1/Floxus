<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foxus</title>
    <!-- Favicon link for the browser tab -->
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/khvnf1/Foxus/refs/heads/main/Logo/FoxL.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Updated Font Import: Archivo Black for clock/timers -->
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: white;
        }
        /* Apply Archivo Black to the clock and timer elements */
        #clock, #timer-display, #mini-timer-display {
            font-family: 'Archivo Black', sans-serif; /* Fallback to a generic sans-serif font */
        }
        #settings-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #settings-sidebar.open {
            transform: translateX(0);
        }
        #settings-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .mode-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .hidden-element {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .visible-element {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .mode-switcher-btn.active svg, .timer-mode-btn.active {
            color: #60A5FA;
            background-color: rgba(96, 165, 250, 0.1);
        }
        .settings-nav-item {
            transition: background-color 0.2s;
        }
        .settings-nav-item.active {
            background-color: rgba(96, 165, 250, 0.2);
            color: #60A5FA;
            font-weight: 600;
        }
        .settings-page {
            display: none;
        }
        .settings-page.active {
            display: block;
        }
        .clock-format-option.selected {
            border-color: #3B82F6; /* blue-500 */
        }
        .task-item { transition: opacity 0.3s ease, transform 0.3s ease; }
        .task-item.removing { opacity: 0; transform: translateX(20px); }
        .task-input-container { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .task-input-container.open { max-height: 100px; margin-top: 1rem; }

        /* Custom styles for the theme selection, overriding/extending Tailwind if needed */
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #000000; /* Darker background for settings */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .theme-section {
            margin-bottom: 30px;
        }

        .theme-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Responsive grid */
            gap: 15px;
            justify-items: center;
        }

        /* Updated theme-item styles */
        .theme-item {
            cursor: pointer;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 180px; /* Adjusted height for larger image */
            background-color: transparent; /* Ensure no blue background */
        }

        .theme-item:hover {
            /* No outer border changes on hover */
        }

        .theme-item.selected {
            /* No outer border changes on selected, background transparent */
            background-color: transparent;
        }

        .theme-item img {
            max-width: 100%;
            height: 110px; /* Increased height for preview images */
            object-fit: cover;
            border-radius: 0.5rem; /* rounded-lg from clock images */
            margin-bottom: 0px; /* Changed from 4px to 0px */
            background-color: #333; /* Darker background for image itself */
            border: 2px solid transparent; /* Start with transparent border */
            transition: border-color 0.2s ease-in-out, border-width 0.2s ease-in-out; /* Smooth transitions for border */
            aspect-ratio: 141 / 88; /* Ensure consistent aspect ratio */
        }

        .theme-item:hover img {
            border-color: rgba(255, 255, 255, 0.7); /* Subtle white on hover */
        }

        .theme-item.selected img {
            border-color: white; /* Solid white when selected */
            border-width: 3px; /* Slightly thicker border when selected */
        }

        .theme-item span {
            font-size: 0.9rem;
            font-weight: 700; /* Made text bold */
            color: #ccc; /* Lighter text for dark background */
            word-break: break-word; /* Allow long names to wrap */
            margin-top: 0px; /* Added to remove any default top margin */
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .theme-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            .theme-item {
                height: 160px; /* Adjusted height for smaller screens */
            }
            .theme-item img {
                height: 90px; /* Adjusted height for smaller screens */
            }
        }

        /* Custom switch styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        /* Music Controls Styling */
        #global-music-controls {
            position: fixed;
            bottom: 1.5rem; /* bottom-6 */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.4); /* Slightly darker, more opaque */
            backdrop-filter: blur(8px); /* Stronger blur */
            padding: 0.5rem 1.5rem; /* Thinner height, wider horizontal padding */
            border-radius: 9999px; /* Pill shape */
            display: flex;
            align-items: center;
            gap: 1rem; /* space-x-4 equivalent */
            z-index: 20;
            width: clamp(280px, 60vw, 500px); /* Responsive width: min 280px, max 500px, fluid 60% of viewport width */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Subtle shadow */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white border */
        }

        #global-music-controls button {
            padding: 0.6rem; /* Slightly larger buttons */
            border-radius: 9999px; /* Fully rounded buttons */
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #global-music-controls button:hover {
            transform: translateY(-2px); /* Slight lift on hover */
        }

        #global-music-controls button svg {
            width: 1.5rem; /* Larger icons */
            height: 1.5rem;
        }

        #music-play-pause-btn {
            padding: 0.8rem; /* Larger play/pause button */
        }
        #music-play-pause-btn svg {
            width: 1.75rem; /* Larger play/pause icon */
            height: 1.75rem;
        }

        /* Text container for scrolling */
        #global-music-controls .flex-grow {
            flex-grow: 1; /* Takes available space */
            overflow: hidden;
            position: relative;
            height: 1.5rem; /* Fixed height for the text area */
            display: flex; /* Use flex to center short text */
            align-items: center; /* Vertically center short text */
            /* justify-content: center; Removed, handled by JS for short text */
        }

        #music-track-title {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: white;
            white-space: nowrap; /* Prevent wrapping */
            position: absolute; /* Always absolute for consistent behavior */
            top: 50%; /* Vertically center */
            /* transform: translateY(-50%); This will be part of the base transform, not animation */
            left: 0; /* Default to left for scrolling, or adjusted for centering */
            transition: transform 0.3s ease-in-out; /* Smooth transition for centering */
        }

        /* Marquee animation */
        @keyframes slideText {
            0% { transform: translateX(0) translateY(-50%); }
            50% { transform: translateX(var(--slide-distance)) translateY(-50%); }
            100% { transform: translateX(0) translateY(-50%); }
        }

        /* Live Wallpaper Player Styling */
        #live-wallpaper-player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind other content */
            overflow: hidden;
            pointer-events: none; /* Allow clicks to pass through */
            opacity: 0; /* Start hidden */
            transition: opacity 0.5s ease-in-out; /* Smooth transition */
        }

        #live-wallpaper-player-container.visible-element {
            opacity: 1; /* Make visible */
        }

        /* Ensures the iframe covers the container without black bars */
        #live-wallpaper-player iframe {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            /* These aspect ratio rules ensure the video covers the screen */
            /* For 16:9 videos, if screen is wider than 16:9, height is 100% and width expands */
            /* If screen is taller than 16:9, width is 100% and height expands */
            width: 100vw;
            height: 56.25vw; /* 9/16 * 100vw */
        }

        @media (min-aspect-ratio: 16/9) {
            #live-wallpaper-player iframe {
                width: 177.77777778vh; /* 16/9 * 100vh */
                height: 100vh;
            }
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- Main Container for content + background -->
    <div id="main-container" class="relative h-full">
        <!-- Background -->
        <div id="background-container" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-1000">
            <!-- Removed the darkening overlay div -->
        </div>

        <!-- Live Wallpaper Player Iframe Container -->
        <div id="live-wallpaper-player-container" class="fixed inset-0 z-0 hidden-element">
            <div id="live-wallpaper-player"></div>
        </div>

        <!-- Logo/Name -->
        <div class="fixed top-5 left-5 z-20">
            <img src="https://raw.githubusercontent.com/khvnf1/Floxus/refs/heads/main/Logo/FoxusC.svg" 
                 onerror="
                     console.error('Failed to load SVG logo (FoxusC.svg). Trying PNG fallback...');
                     this.onerror=function() {
                         console.error('Failed to load PNG logo (FoxusC.png). Using placeholder.');
                         this.src='https://placehold.co/150x61.07/FF0000/FFFFFF?text=LOGO+ERROR';
                         this.onerror=null; // Prevent infinite loop if placeholder also fails (unlikely)
                     };
                     this.src='https://raw.githubusercontent.com/khvnf1/Floxus/refs/heads/main/Logo/FoxusC.png';
                 "
                 alt="FloxusC Logo" 
                 class="w-[150px] h-[61.07px] object-contain">
        </div>

        <!-- Main Content Area (Modes) -->
        <div id="app" class="relative z-10">
            <!-- Home Mode -->
            <div id="home-mode" class="mode-screen hidden-element flex flex-col items-center justify-center h-screen text-center p-4">
                <!-- Changed text size from text-8xl md:text-9xl to text-9xl md:text-[10rem] for larger clock -->
                <h1 id="clock" class="text-9xl md:text-[10rem] font-bold tracking-tight">12:00</h1>
                <p id="greeting" class="text-2xl md:text-3xl mt-4">Good evening, Farhan.</p>
                <!-- Repositioned and bolded quote -->
                <p id="quote" class="absolute top-4 right-4 text-lg md:text-xl font-bold text-right max-w-xs p-2">"The secret of getting ahead is getting started."</p>
            </div>

            <!-- Focus Mode -->
            <div id="focus-mode" class="mode-screen hidden-element flex items-center justify-center h-screen p-4">
                <div class="w-full max-w-md mx-auto bg-black/20 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-2xl flex flex-col">
                    <!-- Timer Section -->
                    <div class="flex flex-col items-center">
                        <div class="flex items-center justify-center space-x-2 mb-6 bg-gray-800/50 p-1 rounded-full">
                            <button id="pomodoro-mode-btn" class="timer-mode-btn p-2 rounded-full text-gray-300 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg></button>
                            <button id="countdown-mode-btn" class="timer-mode-btn p-2 rounded-full text-gray-300 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                            <button id="stopwatch-mode-btn" class="timer-mode-btn p-2 rounded-full text-gray-300 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></button>
                            <button id="animedoro-mode-btn" class="timer-mode-btn p-2 rounded-full text-gray-300 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                        </div>
                        <div id="timer-display" class="text-7xl md:text-8xl font-bold my-4">25:00</div>
                        <div class="flex items-center space-x-4 mt-6">
                            <button id="reset-timer-btn" class="p-4 rounded-full bg-gray-700/60 hover:bg-gray-600/60 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5" /><path stroke-linecap="round" stroke-linejoin="round" d="M20 12A8 8 0 1013 5.23" /></svg></button>
                            <button id="start-pause-timer-btn" class="text-xl font-semibold px-8 py-4 rounded-full bg-blue-600 hover:bg-blue-500 transition-colors shadow-lg">Start</button>
                            <button id="skip-break-btn" class="p-4 rounded-full bg-gray-700/60 hover:bg-gray-600/60 transition-colors hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg></button>
                        </div>
                        <div id="session-tally" class="flex items-center space-x-2 mt-8 h-6"></div>
                    </div>
                    <hr class="border-gray-600/50 my-8 w-full">
                    <div class="w-full flex flex-col items-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4">Focus Priority</h3>
                        <div id="todo-list-container" class="w-full min-h-[6rem] flex items-center justify-center"></div>
                        <div id="add-task-container" class="w-full flex justify-center items-center space-x-2 mt-4">
                            <button id="add-task-btn" class="p-2 rounded-full bg-gray-700/60 hover:bg-gray-600/60 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
                        </div>
                         <div id="new-task-input-container" class="w-full task-input-container">
                            <input type="text" id="new-task-input" class="w-full bg-gray-800/70 border-2 border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" placeholder="Add a new priority...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ambient Mode -->
            <div id="ambient-mode" class="mode-screen hidden-element relative h-screen">
                 <div id="mini-timer-container" class="absolute top-4 right-4 bg-black/30 p-3 rounded-lg flex items-center space-x-2">
                    <span id="mini-timer-display" class="text-xl font-semibold">25:00</span>
                    <button id="mini-start-pause-btn" class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 transition-colors text-white"><svg id="mini-start-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3l14 9-14 9V3z" /></svg><svg id="mini-pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                 </div>
            </div>
        </div>

        <!-- Settings Icon -->
        <button id="settings-btn" class="fixed bottom-5 left-5 z-20 p-2 rounded-full text-white bg-gray-800/50 hover:bg-gray-700/80 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>

        <!-- Mode Switcher -->
        <div class="fixed bottom-5 right-5 z-20 flex flex-col space-y-3 bg-gray-800/50 backdrop-blur-sm p-2 rounded-full">
            <button id="home-btn" class="mode-switcher-btn active p-2 rounded-full text-white hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></button>
            <button id="focus-btn" class="mode-switcher-btn p-2 rounded-full text-white hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
            <button id="ambient-btn" class="mode-switcher-btn p-2 rounded-full text-white hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.881 4.002l1.414 1.414M14.706 4.002l1.415 1.414M4.222 19.778l1.414-1.414M18.364 19.778l1.414-1.414" /></svg></button>
        </div>

        <!-- Music Controls (Global) -->
        <div id="global-music-controls" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/30 p-3 rounded-lg flex items-center space-x-4 z-20">
            <button id="music-prev-btn" class="p-2 rounded-full bg-gray-700/60 hover:bg-gray-600/60 transition-colors text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
            </button>
            <button id="music-play-pause-btn" class="p-3 rounded-full bg-blue-600 hover:bg-blue-500 transition-colors text-white">
                <svg id="music-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <svg id="music-pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <button id="music-next-btn" class="p-2 rounded-full bg-gray-700/60 hover:bg-gray-600/60 transition-colors text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
            </button>
            <!-- Container for the scrolling track title -->
            <div class="flex-grow overflow-hidden relative">
                <div id="music-track-title" class="text-sm font-semibold text-white whitespace-nowrap"></div>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/50 z-30 hidden-element"></div>

    <!-- Settings Sidebar -->
    <div id="settings-sidebar" class="fixed top-0 left-0 h-full w-4/5 md:w-2/3 lg:w-1/2 bg-black/95 backdrop-blur-lg z-40 flex shadow-2xl">
        <!-- Left Navigation -->
        <!-- Changed width from w-1/3 to w-1/4 for a narrower panel -->
        <div class="w-1/4 border-r border-gray-700/50 p-4">
            <h2 class="text-2xl font-bold mb-8 text-white">Settings</h2>
            <nav id="settings-nav" class="space-y-2 text-gray-300">
                <div>
                    <!-- Added whitespace-nowrap to keep text on a single line -->
                    <h3 class="text-xs uppercase text-gray-500 font-semibold tracking-wider mb-2 whitespace-nowrap">Themes</h3>
                    <ul>
                        <li><a href="#home-theme" class="settings-nav-item block p-2 rounded-md">Home Theme</a></li>
                        <li><a href="#focus-theme" class="settings-nav-item block p-2 rounded-md">Focus Theme</a></li>
                        <li><a href="#ambient-theme" class="settings-nav-item block p-2 rounded-md">Ambient Theme</a></li>
                    </ul>
                </div>
                <hr class="border-gray-700/50 my-4">
                <div>
                     <!-- Added whitespace-nowrap to keep text on a single line -->
                     <h3 class="text-xs uppercase text-gray-500 font-semibold tracking-wider mb-2 whitespace-nowrap">General</h3>
                     <ul>
                        <li><a href="#clock-settings" class="settings-nav-item block p-2 rounded-md">Clock</a></li>
                        <li><a href="#focus-timer-settings" class="settings-nav-item block p-2 rounded-md">Focus Timer</a></li>
                        <!-- New: Music Settings Navigation Item -->
                        <li><a href="#music-settings" class="settings-nav-item block p-2 rounded-md">Music</a></li>
                    </ul>
                </div>
            </nav>
        </div>
        <!-- Right Content -->
        <!-- Changed width from w-3/5 to w-3/4 for a wider panel -->
        <div id="settings-content" class="w-3/4 p-6 overflow-y-auto text-gray-200">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            
            <!-- Home Theme Settings Page -->
            <div id="home-theme-page" class="settings-page">
                <h3 class="text-xl font-semibold mb-4">Home Theme</h3>
                <!-- Changed grid-cols-2 to grid-cols-3 for themes -->
                <div id="home-theme-options" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Focus Theme Settings Page -->
            <div id="focus-theme-page" class="settings-page">
                <h3 class="text-xl font-semibold mb-4">Focus Theme</h3>
                <!-- Changed grid-cols-2 to grid-cols-3 for themes -->
                <div id="focus-theme-options" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Ambient Theme Settings Page -->
            <div id="ambient-theme-page" class="settings-page">
                <h3 class="text-xl font-semibold mb-4">Ambient Theme</h3>
                <!-- Changed grid-cols-2 to grid-cols-3 for themes -->
                <div id="ambient-theme-options" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Clock Settings Page -->
            <div id="clock-settings-page" class="settings-page space-y-6">
                <h3 class="text-xl font-semibold">Clock Settings</h3>
                <div>
                    <label for="dashboard-name-input" class="block text-sm font-medium text-gray-300">Dashboard Name</label>
                    <input type="text" id="dashboard-name-input" class="mt-1 w-full bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" placeholder="Enter your name">
                </div>
                <hr class="border-gray-700/50">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Clock Format</label>
                    <div class="mt-2 grid grid-cols-2 gap-4">
                        <!-- 12-hour option -->
                        <div id="format-12h-option" class="clock-format-option cursor-pointer p-2 border-4 border-transparent rounded-xl transition-colors">
                            <img src="Clock/12h.jpg"
                                 onerror="this.onerror=null; this.src='https://placehold.co/141x88/e0e0e0/555555?text=12H';"
                                 alt="12-hour clock format preview"
                                 class="w-full rounded-lg aspect-[141/88] object-cover bg-gray-800">
                            <p class="text-center text-sm mt-2">12-hour Clock</p>
                        </div>
                        <!-- 24-hour option -->
                        <div id="format-24h-option" class="clock-format-option cursor-pointer p-2 border-4 border-transparent rounded-xl transition-colors">
                            <img src="Clock/24h.jpg"
                                 onerror="this.onerror=null; this.src='https://placehold.co/141x88/e0e0e0/555555?text=24H';"
                                 alt="24-hour clock format preview"
                                 class="w-full rounded-lg aspect-[141/88] object-cover bg-gray-800">
                            <p class="text-center text-sm mt-2">24-hour Clock</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Focus Timer Settings Page -->
            <div id="focus-timer-settings-page" class="settings-page space-y-6">
                <h3 class="text-xl font-semibold">Focus Timer Settings</h3>
                <div>
                    <h4 class="text-md font-semibold mb-2 text-gray-300">Timer Lengths (minutes)</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="pomodoro-focus-input" class="block text-sm font-medium text-gray-400">Pomodoro Focus</label>
                            <input type="number" id="pomodoro-focus-input" class="mt-1 w-full bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500" min="1" value="25">
                        </div>
                        <div>
                            <label for="pomodoro-short-break-input" class="block text-sm font-medium text-gray-400">Short Break</label>
                            <input type="number" id="pomodoro-short-break-input" class="mt-1 w-full bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500" min="1" value="5">
                        </div>
                        <div>
                            <label for="pomodoro-long-break-input" class="block text-sm font-medium text-gray-400">Long Break</label>
                            <input type="number" id="pomodoro-long-break-input" class="mt-1 w-full bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500" min="1" value="15">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-md font-semibold mb-2 text-gray-300">Alert Sounds</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="alert-sound-select" class="block text-sm font-medium text-gray-400">Sound</label>
                            <select id="alert-sound-select" class="mt-1 w-full bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="C5">Chime</option>
                                <option value="G4">Bell</option>
                                <option value="E5">Synth</option>
                            </select>
                        </div>
                        <div>
                            <label for="alert-volume-input" class="block text-sm font-medium text-gray-400">Volume</label>
                            <input type="range" id="alert-volume-input" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" min="0" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- New: Music Settings Page -->
            <div id="music-settings-page" class="settings-page space-y-6">
                <h3 class="text-xl font-semibold">Music</h3>
                <p class="text-sm text-gray-400">Make sure you're logged into your streaming service's web player in the same browser as Flocus. After logging in, hard refresh your Flocus tab (Cmd/Ctrl + Shift + R).</p>
                <hr class="border-gray-700/50">
                <div>
                    <h4 class="text-md font-semibold mb-2 text-gray-300">Custom Playlists</h4>
                    <p class="text-sm text-gray-400 mb-4">Add your favorite playlist from YouTube or Youtube Music.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="music-url-input" class="flex-grow bg-gray-700/70 border-2 border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500" placeholder="Paste playlist or video url here">
                        <button id="save-music-url-btn" class="px-5 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-semibold transition-colors">Save</button>
                    </div>
                    <button id="clear-music-btn" class="mt-4 px-5 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-white font-semibold transition-colors w-full">Clear Music</button>
                </div>
                <hr class="border-gray-700/50">
                <div>
                    <h4 class="text-md font-semibold mb-2 text-gray-300">Player Visibility</h4>
                    <div class="flex items-center justify-between">
                        <label for="toggle-music-controls" class="text-gray-300">Show Music Player Controls</label>
                        <label class="switch">
                            <input type="checkbox" id="toggle-music-controls">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <hr class="border-gray-700/50">
                <div>
                    <h4 class="text-md font-semibold mb-2 text-gray-300">Live Wallpaper Audio</h4>
                    <div class="flex items-center justify-between">
                        <label for="toggle-live-wallpaper-audio" class="text-gray-300">Play Audio from Live Wallpaper</label>
                        <label class="switch">
                            <input type="checkbox" id="toggle-live-wallpaper-audio">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Player Iframe (Hidden) -->
    <!-- This iframe will host the YouTube player. It's set to be invisible (width/height 0)
         as only audio playback is desired. -->
    <div class="fixed bottom-0 right-0 w-0 h-0 overflow-hidden">
        <div id="youtube-player"></div>
    </div>

    <!-- YouTube IFrame Player API Script -->
    <!-- This script is required to use the YouTube IFrame Player API.
         It defines the YT object and calls window.onYouTubeIframeAPIReady when ready. -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const mainContainer = document.getElementById('main-container');
            const backgroundContainer = document.getElementById('background-container');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsSidebar = document.getElementById('settings-sidebar');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const settingsNav = document.getElementById('settings-nav');
            
            const modes = ['home', 'focus', 'ambient'];
            const modeButtons = { home: document.getElementById('home-btn'), focus: document.getElementById('focus-btn'), ambient: document.getElementById('ambient-btn') };
            const modeScreens = { home: document.getElementById('home-mode'), focus: document.getElementById('focus-mode'), ambient: document.getElementById('ambient-mode') };
            
            const clockElement = document.getElementById('clock');
            const greetingElement = document.getElementById('greeting');
            const quoteElement = document.getElementById('quote');
            
            const timerDisplay = document.getElementById('timer-display');
            const startPauseBtn = document.getElementById('start-pause-timer-btn');
            const resetBtn = document.getElementById('reset-timer-btn');
            const skipBtn = document.getElementById('skip-break-btn');
            const sessionTallyContainer = document.getElementById('session-tally');
            const timerModeButtons = { pomodoro: document.getElementById('pomodoro-mode-btn'), countdown: document.getElementById('countdown-mode-btn'), stopwatch: document.getElementById('stopwatch-mode-btn'), animedoro: document.getElementById('animedoro-mode-btn') };

            const miniTimerDisplay = document.getElementById('mini-timer-display');
            const miniStartIcon = document.getElementById('mini-start-icon');
            const miniPauseIcon = document.getElementById('mini-pause-icon');
            const miniStartPauseBtn = document.getElementById('mini-start-pause-btn');


            const todoContainer = document.getElementById('todo-list-container');
            const addTaskBtn = document.getElementById('add-task-btn');
            const newTaskInputContainer = document.getElementById('new-task-input-container');
            const newTaskInput = document.getElementById('new-task-input');

            // Settings Page Elements
            const dashboardNameInput = document.getElementById('dashboard-name-input');
            const format12hOption = document.getElementById('format-12h-option');
            const format24hOption = document.getElementById('format-24h-option');
            const pomodoroFocusInput = document.getElementById('pomodoro-focus-input');
            const pomodoroShortBreakInput = document.getElementById('pomodoro-short-break-input'); // Corrected typo
            const pomodoroLongBreakInput = document.getElementById('pomodoro-long-break-input');
            const alertSoundSelect = document.getElementById('alert-sound-select');
            const alertVolumeInput = document.getElementById('alert-volume-input');

            // Music Player Elements
            const globalMusicControls = document.getElementById('global-music-controls'); // New: Global music controls container
            const musicUrlInput = document.getElementById('music-url-input');
            const saveMusicUrlBtn = document.getElementById('save-music-url-btn');
            const clearMusicBtn = document.getElementById('clear-music-btn'); // New: Clear Music button
            const musicPlayPauseBtn = document.getElementById('music-play-pause-btn');
            const musicPlayIcon = document.getElementById('music-play-icon');
            const musicPauseIcon = document.getElementById('music-pause-icon');
            const musicPrevBtn = document.getElementById('music-prev-btn');
            const musicNextBtn = document.getElementById('music-next-btn');
            const toggleMusicControls = document.getElementById('toggle-music-controls'); // New: Music controls visibility toggle
            const musicTrackTitleElement = document.getElementById('music-track-title'); // New: Track title element

            // New Live Wallpaper Player Elements
            const liveWallpaperPlayerContainer = document.getElementById('live-wallpaper-player-container');
            const toggleLiveWallpaperAudio = document.getElementById('toggle-live-wallpaper-audio');
            let liveWallpaperPlayer; // Will hold the YT.Player object for live wallpaper

            // --- Data & State ---
            const quotes = ["The only way to do great work is to love what you do.", "Success is not final, failure is not fatal: it is the courage to continue that counts.", "Believe you can and you're halfway there.", "The future belongs to those who believe in the beauty of their dreams.", "The secret of getting ahead is getting started.", "Don't watch the clock; do what it does. Keep going."];
            
            // --- START: MANUALLY EDIT THIS SECTION EACH TIME YOU ADD/REMOVE A THEME ---
            // Define all your themes here.
            // 'id': A unique identifier for the theme (e.g., matching the filename without extension).
            // 'name': The display name for the theme on the settings page.
            // 'imageUrl': The path to your local image (e.g., 'Themes/Grad_Sunrise.jpg') OR a direct URL (e.g., Unsplash link).
            // 'youtubeId': (Optional, for type 'live') The YouTube video ID for the live wallpaper.
            // 'videoUrl': (Optional, for mediaType 'video') The path to your local MP4 video file.
            // 'type': 'gradient', 'ambient', or 'live' to categorize it for display in the settings.
            // 'mediaType': (Optional) 'video' if it's an MP4 video, otherwise it's implicitly an image.
            const allThemes = [
                // Gradient and Colours Themes (prefix Grad_)
                {
                    id: 'Grad_AuraTwilight',
                    name: 'Aura Twilight',
                    imageUrl: 'Themes/Grad_AuraTwilight.jpg', // Local image path
                    type: 'gradient'
                },
                {
                    id: 'Grad_PeachAuraHeart',
                    name: 'Peach Aura Heart',
                    imageUrl: 'Themes/Grad_PeachAuraHeart.jpg', // Local image path
                    type: 'gradient'
                },
                {
                    id: 'Grad_GrainyGradient',
                    name: 'Grainy Gradient',
                    imageUrl: 'Themes/Grad_GrainyGradient.jpg', // Local image path
                    type: 'gradient'
                },
                
                // Add more gradient themes here following the same structure
                // { id: 'Grad_YourNewTheme', name: 'Your New Theme', imageUrl: 'Themes/Grad_YourNewTheme.jpg', type: 'gradient' },


                // Ambient Worlds Themes (prefix Amb_)
                {
                    id: 'Amb_CountrysideMorning',
                    name: 'Countryside Morning',
                    imageUrl: 'Themes/Amb_CountrysideMorning.jpg', // Local image path
                    type: 'ambient'
                },
                {
                    id: 'Amb_LofiClouds',
                    name: 'Lofi Clouds',
                    imageUrl: 'Themes/Amb_LofiClouds.jpg', // Local image path
                    type: 'ambient'
                },
                {
                    id: 'Amb_TotoForest',
                    name: 'Toto Forest',
                    imageUrl: 'Themes/Amb_TotoForest.jpg', // Unsplash URL
                    type: 'ambient'
                },
                {
                    id: 'Amb_1DuskPeak',
                    name: 'Dusk Peak',
                    imageUrl: 'Themes/Amb_1DuskPeak.png', // Unsplash URL
                    type: 'ambient'
                },
                {
                    id: 'Amb_2AustrianAlps',
                    name: 'Austrian Alps',
                    imageUrl: 'Themes/Amb_2AustrianAlps.png', // Unsplash URL
                    type: 'ambient'
                },
                {
                    id: 'Amb_Rainforest1',
                    name: 'Rainforest View',
                    imageUrl: 'Themes/Amb_Rainforest1.jpg', // Unsplash URL
                    type: 'ambient'
                },
                {
                    id: 'Amb_TropicalBeach',
                    name: 'Tropical Beach',
                    imageUrl: 'Themes/Amb_TropicalBeach.jpg', // Unsplash URL
                    type: 'ambient'
                },
                {
                    id: 'Amb_GreenHaven',
                    name: 'Green Haven',
                    imageUrl: 'Themes/Amb_GreenHaven.jpg', // Unsplash URL
                    type: 'ambient'
                },
                // Add more ambient themes here following the same structure
                // { id: 'Amb_YourNewTheme', name: 'Your New Theme', imageUrl: 'Themes/Amb_YourNewTheme.jpg', type: 'ambient' },

                // Live Wallpapers (prefix Live_)
                {
                    id: 'Live_TokyoBalcony',
                    name: 'Tokyo Balcony',
                    youtubeId: 'i_ZmwejvU8M', // Example YouTube video ID for a rainy cafe ambiance
                    type: 'live'
                },
                {
                    id: 'Live_Return',
                    name: 'Return to Study',
                    youtubeId: 'tnhizk_YofQ', // Example YouTube video ID for a rainy cafe ambiance
                    type: 'live'
                },
                {
                    id: 'Live_1Ghibli',
                    name: 'Less Talk, More Action',
                    youtubeId: '9kzE8isXlQY', // Example YouTube video ID for a rainy cafe ambiance
                    type: 'live'
                },
                {
                    id: 'Live_LofiGirl',
                    name: 'Lofi Girl',
                    youtubeId: 'jfKfPfyJRdk', // Example YouTube live stream ID for Lofi Girl
                    type: 'live'
                },
                {
                    id: 'Live_PeacefulSolitude',
                    name: 'Peaceful Solitude',
                    youtubeId: 'F02iMCEEQWs', // Another example
                    type: 'live'
                },
                // Add more live themes here
            ];
            // --- END: MANUALLY EDIT SECTION ---


            let timerInterval = null;
            let timerState = 'idle';
            let currentAppMode = 'home';
            let timeInSeconds = 25 * 60;
            let pomodoroSessionCount = 0;
            let isBreakTime = false;
            
            let appSettings = {}; // Populated by loadSettings
            let tasks = [];
            let currentTaskIndex = 0;

            // YouTube Player API variables
            let player; // This will hold the YT.Player object for main music
            // No need for currentPlaylist and currentPlaylistIndex here, as the player handles it internally
            // based on loadPlaylist/videoById.

            // --- Utility Functions ---
            const formatTime = (seconds) => { const mins = Math.floor(seconds / 60).toString().padStart(2, '0'); const secs = (seconds % 60).toString().padStart(2, '0'); return `${mins}:${secs}`; };
            const playSound = () => { try { const synth = new Tone.Synth().toDestination(); synth.volume.value = Tone.gainToDb(appSettings.alertVolume); synth.triggerAttackRelease(appSettings.alertSound, "8n", Tone.now()); } catch (e) { console.error("Could not play sound:", e); } };

            // --- Settings Logic ---
            function openSettings() { settingsOverlay.classList.remove('hidden-element'); settingsSidebar.classList.add('open'); }
            function closeSettings() { settingsOverlay.classList.add('hidden-element'); settingsSidebar.classList.remove('open'); }
            function saveSettings() { localStorage.setItem('flocusSettings', JSON.stringify(appSettings)); }

            function loadSettings() {
                const savedSettings = localStorage.getItem('flocusSettings');
                const defaultSettings = {
                    dashboardName: 'Farhan',
                    clockFormat: '12h',
                    pomodoro: { focus: 25, shortBreak: 5, longBreak: 15 },
                    alertSound: 'C5',
                    alertVolume: 0.5,
                    // Default themes are now objects with type and url/youtubeId
                    themes: {
                        home: { type: 'image', url: allThemes.find(t => t.type === 'gradient')?.imageUrl || 'https://placehold.co/1920x1080/000000/FFFFFF?text=Home+Theme' },
                        focus: { type: 'image', url: allThemes.find(t => t.type === 'gradient')?.imageUrl || 'https://placehold.co/1920x1080/000000/FFFFFF?text=Focus+Theme' },
                        ambient: { type: 'image', url: allThemes.find(t => t.type === 'ambient')?.imageUrl || 'https://placehold.co/1920x1080/000000/FFFFFF?text=Ambient+Theme' }
                    },
                    music: {
                        currentPlaylistUrl: '',
                        isPlaying: false, // Default to false
                        musicControlsVisible: true,
                        playLiveWallpaperAudio: false
                    }
                };
                
                // Parse saved settings, merging with defaults
                appSettings = savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;

                // Ensure nested objects are properly merged for themes and music
                if (savedSettings) {
                    const parsedSavedSettings = JSON.parse(savedSettings);
                    if (parsedSavedSettings.themes) {
                        appSettings.themes = { ...defaultSettings.themes, ...parsedSavedSettings.themes };
                    }
                    if (parsedSavedSettings.music) {
                        appSettings.music = { ...defaultSettings.music, ...parsedSavedSettings.music };
                        // Force isPlaying to false on load to prevent autoplay
                        appSettings.music.isPlaying = false; 
                    }
                }
                
                dashboardNameInput.value = appSettings.dashboardName;
                pomodoroFocusInput.value = appSettings.pomodoro.focus;
                pomodoroShortBreakInput.value = appSettings.pomodoro.shortBreak;
                pomodoroLongBreakInput.value = appSettings.pomodoro.longBreak;
                alertSoundSelect.value = appSettings.alertSound;
                alertVolumeInput.value = appSettings.alertVolume;
                applyClockFormatSelection();

                if (appSettings.music.currentPlaylistUrl) {
                    musicUrlInput.value = appSettings.music.currentPlaylistUrl;
                    updateTrackTitle('Music loaded, click play'); // Indicate music is loaded but not playing
                } else {
                    updateTrackTitle('No music loaded');
                }
                toggleMusicControls.checked = appSettings.music.musicControlsVisible;
                toggleLiveWallpaperAudio.checked = appSettings.music.playLiveWallpaperAudio; // Set state for new toggle
            }

            function applyClockFormatSelection() {
                if (appSettings.clockFormat === '12h') {
                    format12hOption.classList.add('selected');
                    format24hOption.classList.remove('selected');
                } else {
                    format24hOption.classList.add('selected');
                    format12hOption.classList.remove('selected');
                }
            }

            /**
             * Populates a theme selection container with theme options.
             * @param {string} containerId - The ID of the HTML element to populate (e.g., 'home-theme-options').
             * @param {string} themeModeKey - The key in appSettings.themes (e.g., 'home', 'focus', 'ambient')
             * to store the selected theme object.
             */
            function populateThemeOptions(containerId, themeModeKey) {
                const container = document.getElementById(containerId);
                container.innerHTML = ''; // Clear previous options

                // Filter themes based on the primary type for each section
                const themesForSection = allThemes.filter(theme => {
                    if (themeModeKey === 'home' || themeModeKey === 'focus') {
                        // For Home and Focus, show Gradient and Ambient (including videos categorized as such)
                        return theme.type === 'gradient' || theme.type === 'ambient';
                    }
                    if (themeModeKey === 'ambient') {
                        // For Ambient, show Ambient and Live (including videos categorized as ambient)
                        return theme.type === 'ambient' || theme.type === 'live';
                    }
                    return false;
                });

                // Group themes by their 'type' to create subheadings (e.g., 'Gradient and Colours', 'Ambient Worlds', 'Live Wallpapers')
                const groupedThemes = themesForSection.reduce((acc, theme) => {
                    let groupKey;
                    if (theme.type === 'gradient') {
                        groupKey = 'Gradient and Colours';
                    } else if (theme.type === 'ambient') {
                        groupKey = 'Ambient Worlds';
                    } else if (theme.type === 'live') {
                        groupKey = 'Live Wallpapers';
                    }
                    if (!acc[groupKey]) {
                        acc[groupKey] = [];
                    }
                    acc[groupKey].push(theme);
                    return acc;
                }, {});

                // Render each group
                for (const groupTitle in groupedThemes) {
                    const sectionHeader = document.createElement('h4');
                    sectionHeader.className = 'text-lg font-semibold text-gray-300 col-span-full mt-4 mb-2';
                    sectionHeader.textContent = groupTitle;
                    container.appendChild(sectionHeader);

                    groupedThemes[groupTitle].forEach(theme => {
                        const themeDiv = document.createElement('div');
                        themeDiv.className = 'theme-item cursor-pointer p-2';
                        
                        // Determine if this theme is currently selected
                        let isSelected = false;
                        const currentThemeSetting = appSettings.themes[themeModeKey];
                        if (currentThemeSetting) {
                            if (theme.type === 'live' && currentThemeSetting.type === 'live' && currentThemeSetting.youtubeId === theme.youtubeId) {
                                isSelected = true;
                            } else if (theme.mediaType === 'video' && currentThemeSetting.type === 'video' && currentThemeSetting.videoUrl === theme.videoUrl) {
                                isSelected = true;
                            } else if (theme.mediaType !== 'video' && currentThemeSetting.type === 'image' && currentThemeSetting.url === theme.imageUrl) {
                                isSelected = true;
                            }
                        }
                        
                        if (isSelected) {
                            themeDiv.classList.add('selected');
                        }

                        // Get image URL for preview
                        let previewImageUrl;
                        if (theme.type === 'live') {
                            // Use YouTube thumbnail for live wallpapers
                            previewImageUrl = `https://img.youtube.com/vi/${theme.youtubeId}/mqdefault.jpg`; 
                        } else if (theme.mediaType === 'video') {
                            // Use theme.imageUrl for local video previews, fallback to generic placeholder
                            previewImageUrl = theme.imageUrl || `https://placehold.co/150x90/e0e0e0/555555?text=VIDEO`;
                        }
                        else {
                            previewImageUrl = theme.imageUrl;
                        }

                        themeDiv.innerHTML = `
                            <img src="${previewImageUrl}" 
                                 alt="${theme.name}" 
                                 class="w-full h-24 object-cover rounded-lg aspect-[141/88] bg-gray-800">
                            <span class="text-center text-sm mt-0 text-gray-300">${theme.name}</span>
                        `;
                        
                        const imgElement = themeDiv.querySelector('img');
                        if (isSelected) {
                            imgElement.classList.add('selected');
                        }
                        imgElement.onerror = function() {
                            this.onerror = null;
                            this.src = `https://placehold.co/150x90/e0e0e0/555555?text=${encodeURIComponent(theme.name.replace(/\s/g, '+'))}`;
                            this.alt = `Image not found for ${theme.name}`;
                        };

                        themeDiv.addEventListener('click', () => {
                            if (theme.type === 'live') {
                                appSettings.themes[themeModeKey] = { type: 'live', youtubeId: theme.youtubeId };
                            } else if (theme.mediaType === 'video') {
                                appSettings.themes[themeModeKey] = { type: 'video', videoUrl: theme.videoUrl, imageUrl: theme.imageUrl }; // Save imageUrl for consistency
                            } else {
                                appSettings.themes[themeModeKey] = { type: 'image', url: theme.imageUrl };
                            }
                            saveSettings();
                            switchMode(currentAppMode); // Re-apply current mode to update background
                            populateAllThemePickers(); // Re-render all theme pickers to update selections
                        });
                        container.appendChild(themeDiv);
                    });
                }
            }

            function populateAllThemePickers() {
                populateThemeOptions('home-theme-options', 'home');
                populateThemeOptions('focus-theme-options', 'focus');
                populateThemeOptions('ambient-theme-options', 'ambient');
            }

            function switchSettingsPage(targetPageId) {
                document.querySelectorAll('#settings-content .settings-page').forEach(page => page.classList.remove('active'));
                document.getElementById(targetPageId).classList.add('active');
                document.querySelectorAll('#settings-nav .settings-nav-item').forEach(item => item.classList.remove('active'));
                // Find the navigation item that links to this page and activate it
                const navItem = document.querySelector(`#settings-nav a[href="#${targetPageId.replace('-page','')}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            // --- To-Do List Logic ---
            function renderTodoList() { todoContainer.innerHTML = ''; if (tasks.length === 0) { todoContainer.innerHTML = `<p class="text-gray-400">No priority set. Add a task!</p>`; return; } if (currentTaskIndex >= tasks.length) { currentTaskIndex = tasks.length > 0 ? tasks.length - 1 : 0; } const task = tasks[currentTaskIndex]; const taskItem = document.createElement('div'); taskItem.className = 'task-item w-full flex items-center justify-between'; taskItem.dataset.taskId = task.id; taskItem.innerHTML = `<button class="prev-task-btn p-2 rounded-full hover:bg-gray-700/60 transition-colors ${tasks.length <= 1 ? 'invisible' : ''}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button><div class="flex items-center space-x-3 mx-4 flex-grow"><input type="checkbox" data-task-id="${task.id}" class="task-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600"><span class="text-lg">${task.text}</span></div><button class="next-task-btn p-2 rounded-full hover:bg-gray-700/60 transition-colors ${tasks.length <= 1 ? 'invisible' : ''}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7-7" /></svg></button>`; todoContainer.appendChild(taskItem); taskItem.querySelector('.prev-task-btn').addEventListener('click', showPrevTask); taskItem.querySelector('.next-task-btn').addEventListener('click', showNextTask); taskItem.querySelector('.task-checkbox').addEventListener('change', completeTask); }
            function addTask(text) { if (!text.trim()) return; tasks.push({ id: Date.now(), text: text.trim(), completed: false }); currentTaskIndex = tasks.length - 1; renderTodoList(); newTaskInput.value = ''; newTaskInputContainer.classList.remove('open'); }
            function completeTask(e) { const taskId = parseInt(e.target.dataset.taskId); const taskItem = todoContainer.querySelector(`.task-item[data-task-id="${taskId}"]`); if (taskItem) { taskItem.querySelector('span').classList.add('line-through', 'text-gray-500'); taskItem.classList.add('removing'); setTimeout(() => { tasks = tasks.filter(t => t.id !== taskId); renderTodoList(); }, 300); } }
            function showPrevTask() { if (tasks.length > 1) { currentTaskIndex = (currentTaskIndex - 1 + tasks.length) % tasks.length; renderTodoList(); } }
            function showNextTask() { if (tasks.length > 1) { currentTaskIndex = (currentTaskIndex + 1) % tasks.length; renderTodoList(); } }
            
            // --- Timer Logic ---
            function tick() { if (currentTimerMode === 'stopwatch') timeInSeconds++; else timeInSeconds--; updateTimerDisplay(); if (timeInSeconds <= 0 && currentTimerMode !== 'stopwatch') { playSound(); handleTimerEnd(); } }
            function handleTimerEnd() { clearInterval(timerInterval); timerState = 'idle'; updateStartPauseButtons(); if (currentTimerMode === 'pomodoro') { if (!isBreakTime) { pomodoroSessionCount++; updateSessionTally(); isBreakTime = true; const breakDuration = pomodoroSessionCount % 4 === 0 ? appSettings.pomodoro.longBreak * 60 : appSettings.pomodoro.shortBreak * 60; setTimer(breakDuration); skipBtn.classList.remove('hidden'); } else { isBreakTime = false; setTimer(appSettings.pomodoro.focus * 60); skipBtn.classList.add('hidden'); } } else if (currentTimerMode === 'animedoro') { if (!isBreakTime) { isBreakTime = true; setTimer(20 * 60); } else { isBreakTime = false; setTimer(40 * 60); } } else { resetTimer(); } }
            function startTimer() { if (timerState === 'running') return; timerState = 'running'; updateStartPauseButtons(); timerInterval = setInterval(tick, 1000); }
            function pauseTimer() { if (timerState !== 'running') return; timerState = 'paused'; updateStartPauseButtons(); clearInterval(timerInterval); }
            function resetTimer() { clearInterval(timerInterval); timerState = 'idle'; updateStartPauseButtons(); isBreakTime = false; skipBtn.classList.add('hidden'); switch (currentTimerMode) { case 'pomodoro': setTimer(appSettings.pomodoro.focus * 60); break; case 'countdown': setTimer(30 * 60); break; case 'stopwatch': setTimer(0); break; case 'animedoro': setTimer(40 * 60); break; } }
            function setTimer(seconds) { timeInSeconds = seconds; updateTimerDisplay(); }
            function updateTimerDisplay() { const formattedTime = formatTime(timeInSeconds); timerDisplay.textContent = formattedTime; miniTimerDisplay.textContent = formattedTime; }
            function updateStartPauseButtons() { if (timerState === 'running') { startPauseBtn.textContent = 'Pause'; miniStartIcon.classList.add('hidden'); miniPauseIcon.classList.remove('hidden'); } else { startPauseBtn.textContent = 'Start'; miniStartIcon.classList.remove('hidden'); miniPauseIcon.classList.add('hidden'); } }
            function updateSessionTally() { sessionTallyContainer.innerHTML = ''; for (let i = 0; i < pomodoroSessionCount; i++) { const tallyIcon = document.createElement('div'); tallyIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`; sessionTallyContainer.appendChild(tallyIcon); } }
            function selectTimerMode(mode) { currentTimerMode = mode; Object.values(timerModeButtons).forEach(btn => btn.classList.remove('active')); timerModeButtons[mode].classList.add('active'); pomodoroSessionCount = 0; updateSessionTally(); resetTimer(); }

            // --- Music Player Functions ---
            window.onYouTubeIframeAPIReady = function() {
                player = new YT.Player('youtube-player', {
                    height: '0',
                    width: '0',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 0,
                        'disablekb': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0,
                        'loop': 0,
                        'fs': 0,
                        'iv_load_policy': 3,
                        'enablejsapi': 1,
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });

                liveWallpaperPlayer = new YT.Player('live-wallpaper-player', {
                    height: '100%', // Fill container
                    width: '100%',  // Fill container
                    playerVars: {
                        'autoplay': 1, // Autoplay live wallpaper
                        'controls': 0, // No controls
                        'disablekb': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0,
                        // 'loop': 1, // Removed: Not applicable for live streams and can cause issues
                        'fs': 0,
                        'iv_load_policy': 3,
                        'enablejsapi': 1,
                        'mute': 1, // Start muted, controlled by toggle
                        'playsinline': 1 // Added for better mobile compatibility
                    },
                    events: {
                        'onReady': onLiveWallpaperPlayerReady,
                        'onStateChange': onLiveWallpaperPlayerStateChange
                    }
                });
            };

            function onPlayerReady(event) {
                console.log('Main YouTube Player is ready.');
                if (appSettings.music.currentPlaylistUrl) {
                    loadMusic(appSettings.music.currentPlaylistUrl);
                    // Do NOT call playMusic() here. Music should only play when user clicks.
                }
                updateMusicPlayPauseButtons(); // This will now correctly show "Play" icon
                updateMusicControlsVisibility(); // Ensure visibility is correct on load
                manageAudioPriority(); // Initial audio priority check
            }

            function onLiveWallpaperPlayerReady(event) {
                console.log('Live Wallpaper Player is ready.');
                // Initial mute/unmute based on settings
                if (appSettings.music.playLiveWallpaperAudio) {
                    event.target.unMute();
                } else {
                    event.target.mute();
                }
                // Load the live wallpaper if the current mode's theme is live
                const currentThemeSetting = appSettings.themes[currentAppMode];
                if (currentThemeSetting && currentThemeSetting.type === 'live') {
                    loadLiveWallpaper(currentThemeSetting.youtubeId);
                }
                // Explicitly play the video here too, in case it was cued but not played
                event.target.playVideo(); 
                manageAudioPriority(); // Apply initial audio priority
            }

            function onPlayerStateChange(event) {
                console.log('Main Player state changed:', event.data);
                if (event.data === YT.PlayerState.ENDED) {
                    playNextMusic();
                } else if (event.data === YT.PlayerState.PLAYING) {
                    appSettings.music.isPlaying = true;
                    if (player && typeof player.getVideoData === 'function') {
                        const videoData = player.getVideoData();
                        if (videoData && videoData.title) {
                            updateTrackTitle(videoData.title);
                        } else {
                            updateTrackTitle('Unknown Title');
                        }
                    }
                } else {
                    appSettings.music.isPlaying = false;
                }
                saveSettings();
                updateMusicPlayPauseButtons();
            }

            function onLiveWallpaperPlayerStateChange(event) {
                console.log('Live Wallpaper Player state changed:', event.data);
                // Ensure live wallpaper keeps playing if it gets paused for any reason (e.g., browser policy)
                if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING || event.data === YT.PlayerState.CUED) {
                    const currentThemeSetting = appSettings.themes[currentAppMode];
                    if (currentThemeSetting && currentThemeSetting.type === 'live') {
                        // Only attempt to play if it's supposed to be a live wallpaper
                        event.target.playVideo();
                    }
                }
            }

            function extractYouTubeId(url) {
                let videoId = null;
                let playlistId = null;

                const videoRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
                const videoMatch = url.match(videoRegex);
                if (videoMatch && videoMatch[1]) {
                    videoId = videoMatch[1];
                }

                const playlistRegex = /[?&]list=([a-zA-Z0-9_-]+)/i;
                const playlistMatch = url.match(playlistRegex);
                if (playlistMatch && playlistMatch[1]) {
                    playlistId = playlistMatch[1];
                }

                return { videoId, playlistId };
            }

            function loadMusic(url) {
                if (!player) {
                    console.warn('Main YouTube Player not initialized yet.');
                    return;
                }
                const { videoId, playlistId } = extractYouTubeId(url);
                if (playlistId) {
                    player.loadPlaylist({
                        list: playlistId,
                        listType: 'playlist',
                        index: 0,
                        startSeconds: 0,
                        suggestedQuality: 'small'
                    });
                    console.log('Loading playlist:', playlistId);
                } else if (videoId) {
                    player.loadVideoById(videoId, 0, 'small');
                    console.log('Loading video:', videoId);
                } else {
                    console.error('Invalid YouTube URL provided:', url);
                    updateTrackTitle('Invalid URL');
                }
            }

            function loadLiveWallpaper(youtubeId) {
                if (!liveWallpaperPlayer) {
                    console.warn('Live Wallpaper Player not initialized yet.');
                    return;
                }
                // For looping single videos, you need to specify a playlist of one video
                liveWallpaperPlayer.loadVideoById({
                    videoId: youtubeId,
                    startSeconds: 0,
                    suggestedQuality: 'small'
                });
                liveWallpaperPlayerContainer.classList.add('visible-element');
                liveWallpaperPlayerContainer.classList.remove('hidden-element');
                // Explicitly play the video after loading
                liveWallpaperPlayer.playVideo(); 
                manageAudioPriority(); // Re-evaluate audio priority when new live wallpaper loads
            }

            function playMusic() {
                if (player && typeof player.playVideo === 'function') {
                    player.playVideo();
                    console.log('Playing music.');
                }
            }

            function pauseMusic() {
                if (player && typeof player.pauseVideo === 'function') {
                    player.pauseVideo();
                    console.log('Pausing music.');
                }
            }

            function playNextMusic() {
                if (player && typeof player.nextVideo === 'function') {
                    player.nextVideo();
                    console.log('Playing next music.');
                }
            }

            function playPreviousMusic() {
                if (player && typeof player.previousVideo === 'function') {
                    player.previousVideo();
                    console.log('Playing previous music.');
                }
            }

            function updateMusicPlayPauseButtons() {
                if (appSettings.music.isPlaying) {
                    musicPlayIcon.classList.add('hidden');
                    musicPauseIcon.classList.remove('hidden');
                } else {
                    musicPlayIcon.classList.remove('hidden');
                    musicPauseIcon.classList.add('hidden');
                }
            }

            // Function to control music controls visibility
            function updateMusicControlsVisibility() {
                if (appSettings.music.musicControlsVisible) {
                    globalMusicControls.classList.remove('hidden-element');
                    globalMusicControls.classList.add('visible-element');
                } else {
                    globalMusicControls.classList.add('hidden-element');
                    globalMusicControls.classList.remove('visible-element');
                }
            }

            // Function to update the track title and apply scrolling
            function updateTrackTitle(title) {
                musicTrackTitleElement.textContent = title;
                musicTrackTitleElement.style.animation = 'none'; // Reset animation
                
                // Base vertical centering
                musicTrackTitleElement.style.transform = 'translateY(-50%)'; 

                // Use a small timeout to ensure reflow for accurate measurement
                setTimeout(() => {
                    const containerWidth = musicTrackTitleElement.parentElement.clientWidth;
                    const textWidth = musicTrackTitleElement.scrollWidth;

                    if (textWidth > containerWidth) {
                        // Text is long, apply scrolling animation
                        const speed = 30; // pixels per second
                        const duration = textWidth / speed; 
                        
                        // Adjust slide distance to scroll the full text off-screen and then back
                        const slideDistance = textWidth - containerWidth + 20; // +20px for buffer

                        musicTrackTitleElement.style.setProperty('--slide-distance', `-${slideDistance}px`);
                        musicTrackTitleElement.style.animation = `slideText ${duration}s linear infinite alternate`;
                        musicTrackTitleElement.style.left = '0'; // Start from left for scrolling
                    } else {
                        // Text is short, center it and remove animation
                        musicTrackTitleElement.style.animation = 'none';
                        musicTrackTitleElement.style.left = '50%'; // Center horizontally
                        musicTrackTitleElement.style.transform = 'translate(-50%, -50%)'; // Center both
                    }
                }, 50); // Small delay to ensure measurements are accurate after DOM update
            }

            // New function for audio priority management
            function manageAudioPriority() {
                const currentThemeSetting = appSettings.themes[currentAppMode];
                const isLiveWallpaperActive = currentThemeSetting && (currentThemeSetting.type === 'live' || currentThemeSetting.type === 'video');

                if (appSettings.music.playLiveWallpaperAudio && isLiveWallpaperActive) {
                    // Live wallpaper or local video audio is ON and active
                    if (player && typeof player.mute === 'function') {
                        player.mute(); // Mute main music player
                        player.pauseVideo(); // Pause main music player
                        appSettings.music.isPlaying = false; // Update state
                        updateMusicPlayPauseButtons(); // Update UI
                    }
                    if (liveWallpaperPlayer && typeof liveWallpaperPlayer.unMute === 'function') {
                        liveWallpaperPlayer.unMute(); // Unmute live wallpaper audio
                    }
                    // Mute local video if it exists
                    const localVideo = backgroundContainer.querySelector('video');
                    if (localVideo) {
                        localVideo.muted = false;
                    }

                    // Disable main music player controls
                    musicPrevBtn.disabled = true;
                    musicPlayPauseBtn.disabled = true;
                    musicNextBtn.disabled = true;
                    globalMusicControls.classList.add('opacity-50', 'pointer-events-none'); // Visual disable
                } else {
                    // Live wallpaper/local video audio is OFF or no such background is active
                    if (liveWallpaperPlayer && typeof liveWallpaperPlayer.mute === 'function') {
                        liveWallpaperPlayer.mute(); // Mute live wallpaper audio
                    }
                    // Mute local video if it exists
                    const localVideo = backgroundContainer.querySelector('video');
                    if (localVideo) {
                        localVideo.muted = true;
                    }
                    // Enable main music player controls
                    musicPrevBtn.disabled = false;
                    musicPlayPauseBtn.disabled = false;
                    musicNextBtn.disabled = false;
                    globalMusicControls.classList.remove('opacity-50', 'pointer-events-none'); // Remove visual disable
                    // Note: Main music player's play state is NOT automatically resumed here.
                    // The user needs to manually unpause it if it was paused.
                }
                saveSettings(); // Save the new audio priority state
            }

            // --- General Functions ---
            function switchMode(targetMode) {
                currentAppMode = targetMode;
                if (timerState !== 'idle' && targetMode === 'home') {
                    resetTimer();
                }
                modes.forEach(mode => {
                    const screen = modeScreens[mode];
                    const button = modeButtons[mode];
                    if (mode === targetMode) {
                        screen.classList.remove('hidden-element');
                        screen.classList.add('visible-element');
                        button.classList.add('active');
                    } else {
                        screen.classList.add('hidden-element');
                        screen.classList.remove('visible-element');
                        button.classList.remove('active');
                    }
                });

                // Clear existing background (image, live wallpaper, or video)
                backgroundContainer.style.backgroundImage = 'none';
                liveWallpaperPlayerContainer.classList.add('hidden-element');
                liveWallpaperPlayerContainer.classList.remove('visible-element');
                if (liveWallpaperPlayer && typeof liveWallpaperPlayer.stopVideo === 'function') {
                    liveWallpaperPlayer.stopVideo();
                }

                // Remove any existing video element
                const existingVideo = backgroundContainer.querySelector('video');
                if (existingVideo) {
                    existingVideo.pause();
                    existingVideo.remove();
                }

                // Handle background based on theme type
                const selectedTheme = appSettings.themes[targetMode];
                if (selectedTheme) {
                    if (selectedTheme.type === 'live') {
                        if (liveWallpaperPlayer) {
                            loadLiveWallpaper(selectedTheme.youtubeId); // Load live video
                        }
                    } else if (selectedTheme.type === 'video') { // Check for mediaType 'video'
                        const videoElement = document.createElement('video');
                        videoElement.src = selectedTheme.videoUrl;
                        videoElement.autoplay = true;
                        videoElement.loop = true;
                        videoElement.muted = true; // Start muted, controlled by manageAudioPriority
                        videoElement.playsInline = true; // For iOS compatibility
                        videoElement.className = 'absolute inset-0 w-full h-full object-cover'; // Cover the whole background
                        backgroundContainer.appendChild(videoElement);
                        videoElement.play().catch(error => {
                            console.warn('Video autoplay prevented:', error);
                            // Optionally show a play button or message if autoplay fails
                        });
                    } else if (selectedTheme.type === 'image') { // This covers gradient and ambient images
                        backgroundContainer.style.backgroundImage = `url('${selectedTheme.url}')`; // Set image background
                    }
                } else {
                    // Fallback if no theme or invalid type
                    backgroundContainer.style.backgroundImage = 'none';
                }
                
                updateTimerDisplay();
                updateStartPauseButtons();
                updateMusicControlsVisibility(); // Ensure visibility is correct after mode switch
                manageAudioPriority(); // Re-evaluate audio priority after mode switch
            }
            function updateTime() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                let displayHours;
                if (appSettings.clockFormat === '12h') {
                    displayHours = (hours % 12) || 12;
                } else {
                    displayHours = hours.toString().padStart(2, '0');
                }
                clockElement.textContent = `${displayHours}:${minutes}`;

                let greetingPrefix;
                if (hours < 12) greetingPrefix = 'Good morning'; else if (hours < 18) greetingPrefix = 'Good afternoon'; else greetingPrefix = 'Good evening';
                greetingElement.textContent = `${greetingPrefix}, ${appSettings.dashboardName || 'User'}.`;
            }
            function displayRandomQuote() { const randomIndex = Math.floor(Math.random() * quotes.length); quoteElement.textContent = `"${quotes[randomIndex]}"`; }

            // --- Event Listeners ---
            Object.keys(modeButtons).forEach(mode => modeButtons[mode].addEventListener('click', () => switchMode(mode)));
            settingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            settingsOverlay.addEventListener('click', closeSettings);
            
            settingsNav.addEventListener('click', (e) => { e.preventDefault(); if (e.target.closest('a')) { const targetPageId = e.target.closest('a').getAttribute('href').substring(1) + '-page'; switchSettingsPage(targetPageId); } });
            startPauseBtn.addEventListener('click', () => { if (timerState === 'running') pauseTimer(); else startTimer(); });
            resetBtn.addEventListener('click', resetTimer);
            skipBtn.addEventListener('click', handleTimerEnd);
            Object.keys(timerModeButtons).forEach(mode => timerModeButtons[mode].addEventListener('click', () => selectTimerMode(mode)));
            miniStartPauseBtn.addEventListener('click', () => { if (timerState === 'running') pauseTimer(); else startTimer(); });
            addTaskBtn.addEventListener('click', () => { newTaskInputContainer.classList.toggle('open'); if (newTaskInputContainer.classList.contains('open')) newTaskInput.focus(); });
            newTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(e.target.value); });
            
            // Settings Input Listeners
            dashboardNameInput.addEventListener('input', (e) => { appSettings.dashboardName = e.target.value; saveSettings(); updateTime(); });
            pomodoroFocusInput.addEventListener('input', (e) => { appSettings.pomodoro.focus = parseInt(e.target.value) || 25; saveSettings(); if (currentTimerMode === 'pomodoro' && timerState === 'idle') resetTimer(); });
            pomodoroShortBreakInput.addEventListener('input', (e) => { appSettings.pomodoro.shortBreak = parseInt(e.target.value) || 5; saveSettings(); });
            pomodoroLongBreakInput.addEventListener('input', (e) => { appSettings.pomodoro.longBreak = parseInt(e.target.value) || 15; saveSettings(); });
            alertSoundSelect.addEventListener('change', (e) => { appSettings.alertSound = e.target.value; saveSettings(); playSound(); });
            alertVolumeInput.addEventListener('input', (e) => { appSettings.alertVolume = parseFloat(e.target.value); saveSettings(); });
            format12hOption.addEventListener('click', () => { appSettings.clockFormat = '12h'; saveSettings(); applyClockFormatSelection(); updateTime(); });
            format24hOption.addEventListener('click', () => { appSettings.clockFormat = '24h'; saveSettings(); applyClockFormatSelection(); updateTime(); });

            // Music Player Event Listeners
            saveMusicUrlBtn.addEventListener('click', () => {
                const url = musicUrlInput.value.trim();
                if (url) {
                    appSettings.music.currentPlaylistUrl = url;
                    appSettings.music.isPlaying = false; // Don't autoplay immediately after saving
                    saveSettings();
                    loadMusic(url);
                    updateMusicPlayPauseButtons(); // Update UI to show "Play"
                    updateTrackTitle('Music loaded, click play');
                    closeSettings();
                } else {
                    console.warn('Music URL is empty. Please paste a YouTube video or playlist URL.');
                    updateTrackTitle('No URL provided'); // Display feedback for empty URL
                }
            });

            clearMusicBtn.addEventListener('click', () => {
                appSettings.music.currentPlaylistUrl = '';
                appSettings.music.isPlaying = false;
                saveSettings();
                if (player && typeof player.stopVideo === 'function') {
                    player.stopVideo();
                } else if (player && typeof player.cueVideoById === 'function') {
                    player.cueVideoById(null); // Clear the video
                }
                musicUrlInput.value = '';
                updateMusicPlayPauseButtons();
                updateTrackTitle('No music loaded');
            });

            musicPlayPauseBtn.addEventListener('click', () => {
                if (appSettings.music.isPlaying) {
                    pauseMusic();
                    appSettings.music.isPlaying = false;
                } else {
                    if (appSettings.music.currentPlaylistUrl) { // Only play if a URL is loaded
                        playMusic();
                        appSettings.music.isPlaying = true;
                    } else {
                        console.warn('No music URL loaded to play.');
                        updateTrackTitle('No music to play');
                    }
                }
                saveSettings();
                updateMusicPlayPauseButtons();
            });

            musicPrevBtn.addEventListener('click', () => {
                playPreviousMusic();
                appSettings.music.isPlaying = true; 
                saveSettings();
                updateMusicPlayPauseButtons();
            });

            musicNextBtn.addEventListener('click', () => {
                playNextMusic();
                appSettings.music.isPlaying = true; 
                saveSettings();
                updateMusicPlayPauseButtons();
            });

            // Music controls visibility toggle listener
            toggleMusicControls.addEventListener('change', (e) => {
                appSettings.music.musicControlsVisible = e.target.checked;
                saveSettings();
                updateMusicControlsVisibility();
            });

            // Live wallpaper audio toggle listener
            toggleLiveWallpaperAudio.addEventListener('change', (e) => {
                appSettings.music.playLiveWallpaperAudio = e.target.checked;
                saveSettings();
                manageAudioPriority();
            });


            // --- Initial Setup ---
            loadSettings();
            switchMode('home');
            updateTime();
            setInterval(updateTime, 1000);
            displayRandomQuote();
            populateAllThemePickers();
            selectTimerMode('pomodoro');
            renderTodoList();
            updateStartPauseButtons();
            switchSettingsPage('home-theme-page');
            updateMusicPlayPauseButtons();
            updateMusicControlsVisibility(); // Initial call to set visibility based on settings
            // manageAudioPriority() is called in onPlayerReady and onLiveWallpaperPlayerReady
            // to ensure players are initialized before managing their audio.
        });
    </script>
</body>
</html>
